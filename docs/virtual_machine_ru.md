# Виртульная машина Grad

**Версия 1 (апрель 2025)**

Здесь описаны основные характеристики виртуальной машины Grad.

## Байткод

### Разделы байткода

Содержимое байткода в момент его компиляции разделяется на несколько разделов.
В момент запуска они подвергается разбору, сохраняя в оперативную память
содержащиеся данные.

Эта версия ВМ поддерживает два раздела - функции (`fn`) и программа (`main`).

|№|Имя|Параметры|Действие|
|-|---|---------|--------|
|0|PageMainStart|-|Начало раздела `main`|
|1|PageFnStart|-|Начало раздела `fn`|

## Инструкции `fn`

|№|Имя|Параметры|Действие|
|-|---|---------|--------|
|2|DefineFn|id|Определяет новую функцию|

## Инструкции `main`

### Числа с плавающей точкой

Флаг `FLT` при значении > 0 указывает, что создаваемый далее объект
(контейнер/переменная) имеет тип *float*.

|№|Имя|Параметры|Действие|
|-|---|---------|--------|
|34|SetFlagFloat|value|Если `value` > 0 , то `FLT` = 1, иначе `FLT` = 0 |

### Числовые значения

Эти инструкции позволяют записывать числовые значения в регистр `VAL`.

|№|Имя|Параметры|Действие|
|-|---|---------|--------|
|29|SetValue|value|Устанавливает `VAL` на `value`|
|30|SetExprValue|expr|Вычисляет `expr` и сохраняет результат в `VAL`|
|31|SetVarValue|var|Копирует значение переменной `var` в `VAL`|
|37|SetFloatValue|mant, ord|Устанавливает `VAL` на число *float*|

### Отладка памяти

Флаг `MLOG` при значении > 0 выводит в консоль во время
создания/удаления контейнеров и переменных соответствующее сообщение.

Флаг `MLOGEND` при значении > 0 выводит в консоль существующие переменные
и контейнеры в момент завершения программы.

|№|Имя|Параметры|Действие|
|-|---|---------|--------|
|35|SetFlagMemLog|value|Если `value` > 0 , то `MLOG` = 1, иначе `MLOG` = 0 |
|36|SetFlagMemLogEnd|value|Если `value` > 0 , то `MLOGEND` = 1, иначе `MLOGEND` = 0 |

### Работа с переменными

|№|Имя|Параметры|Действие|
|-|---|---------|--------|
|3|NewVariable|id|Создаёт новую переменную|
|4|DeleteVariable|id|Удаляет переменную|
|5|SetVariable|id|Устанавливает значение переменной из регистра `VAL`|
|6|CopyVariable|id, id_from|Копирует значение переменной `id_from` в `id`|
|8|NulleanVariable|id|Сбрасывает значение переменной на 0|

### Индексация

Эти инструкции позволяют записывать координаты в регистры индексации `IDXX` и
`IDXY`. Инструкции, обращающиеся к элементам контейнера, читают позиции из
этих регистров.

|№|Имя|Параметры|Действие|
|-|---|---------|--------|
|24|SetX|value|Устанавливает позицию по горизонтали на `value`|
|25|SetY|value|Устанавливает позицию по вертикали на `value`|
|26|SetExprX|expr|Устанавливает позицию по горизонтали на результат `expr`|
|27|SetExprY|expr|Устанавливает позицию по вертикали на результат `expr`|
|32|SetVarX|var|Устанавливает позицию по горизонтали из переменной `var`|
|33|SetVarY|var|Устанавливает позицию по вертикали из переменной `var`|

### Работа с контейнерами

Инструкции, обращающиеся к элементам контейнера,
читают значения из регистров индексации (см. выше).

|№|Имя|Параметры|Действие|
|-|---|---------|--------|
|14|NewContainer|id|Создаёт новый контейнер|
|15|DeleteContainer|id|Удаляет контейнер|
|16|SetContainer|id|Устанавливает значение элемента из регистра `VAL`|
|18|ClearContainer|id|Очищает контейнер, устанавливая значение всех элементов на 0|
|19|FillContainer|id|Устанавливает все элементы контейнера из регистра `VAL`|
|22|CopyContainer|id, id_from|Копирует значения контейнера `id_from` в `id`|
|23|GetContainer|id, var|Сохраняет значение контейнера в переменную `var`|

### Сравнения и условные переходы

Виртульная машина имеет флаг `CMP`, значение которого устанавливают
команды сравнения `Compare*`.

|№|Имя|Параметры|Действие|
|-|---|---------|--------|
|9|CompareExpr|expr|Вычисляет `expr`, и если результат > 0, то `CMP` = 1, иначе 0|
|10|CompareExprInv|expr|Противоположно `CompareExpr` - если результат > 0, то `CMP` = 0, иначе 1|

Значение флага `CMP` читается инструкциями *условного перехода*.

|№|Имя|Параметры|Действие|
|-|---|---------|--------|
|11|JumpCmpTrue|op|Если CMP = 1, то переходит на инструкцию №`op`|
|12|JumpCmpFalse|op|Если CMP = 0, то переходит на инструкцию №`op`|
|13|Jump|op|Переходит на инструкцию №`op`|

### Система

|№|Имя|Параметры|Действие|
|-|---|---------|--------|
|28|Halt|-|Немедленно завершить выполнение программы|

## Примеры использования

### Сценарий 1

1. Создать контейнер с размерами 16x16
3. Установить значение первого элемента контейнера на 42
2. Создать переменную
4. Сохранить значение этого элемента в переменную
5. Удалить контейнер

|№|Инструкция|Параметры|
|-|----------|---------|
|1|SetX|16
|2|SetY|16
|3|NewContainer|0
|4|SetX|0
|5|SetY|0
|6|SetValue|42
|7|SetContainer|0
|8|NewVariable|0
|9|GetContainer|0; 0
|10|DeleteContainer|0